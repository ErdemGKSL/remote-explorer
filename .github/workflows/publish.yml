name: 'release'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: read
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish-tauri:
    name: Build Tauri Artifacts
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Desktop builds
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'ubuntu-22.04-arm'
            args: ''
          - platform: 'windows-latest'
            args: ''
          # Android APK build
          - platform: 'ubuntu-22.04'
            args: 'android'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      # ---------- Java (must be before Android SDK setup) ----------
      - name: setup JDK 17 (for Android)
        if: contains(matrix.args, 'android')
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: install dependencies (ubuntu only)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            pkg-config \
            xdg-utils

      # ---------- Android SDK / NDK ----------
      - name: setup Android SDK
        if: contains(matrix.args, 'android')
        uses: android-actions/setup-android@v3

      - name: install Android SDK components
        if: contains(matrix.args, 'android')
        run: |
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;27.3.13750724" \
            "cmake;3.22.1"

      - name: export Android env
        if: contains(matrix.args, 'android')
        run: |
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.3.13750724" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.3.13750724" >> $GITHUB_ENV

      # ---------- Frontend ----------
      - name: setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: install frontend dependencies
        run: bun install --frozen-lockfile

      # ---------- Rust ----------
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ contains(matrix.args, 'android') && 'aarch64-linux-android' || (matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '') }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # ---------- Build ----------
      - name: build tauri app (desktop)
        if: ${{ !contains(matrix.args, 'android') }}
        run: bun tauri build ${{ matrix.args }}

      - name: build tauri android init
        if: contains(matrix.args, 'android')
        run: bun run tauri android init

      - name: setup Android signing
        if: contains(matrix.args, 'android')
        run: |
          cd src-tauri/gen/android
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" > keystore.properties
          echo "password=${{ secrets.ANDROID_KEY_PASSWORD }}" >> keystore.properties
          base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > $RUNNER_TEMP/keystore.jks
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties

      - name: build tauri android apk
        if: contains(matrix.args, 'android')
        run: bun run tauri android build --apk true

      # ---------- Artifacts ----------
      - name: collect artifacts
        shell: bash
        run: |
          mkdir -p release
          find src-tauri -type f \( \
            -name "*.AppImage" -o \
            -name "*.deb" -o \
            -name "*.msi" -o \
            -name "*setup.exe" -o \
            -name "*.dmg" -o \
            -name "*.apk" \
          \) -exec cp -r {} release/ \;
          if [ -f "release/app-universal-release.apk" ]; then
            mv release/app-universal-release.apk release/remote-explorer.apk
          fi

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-${{ matrix.platform }}-${{ matrix.args }}
          path: release/*

  build-arch-package:
    name: Build Arch Linux Package
    runs-on: ubuntu-latest
    needs: publish-tauri
    steps:
      - uses: actions/checkout@v4

      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: prepare release directory
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release

      - name: list artifacts
        run: |
          echo "Contents of release directory:"
          ls -laR release/
          
      - name: build arch package
        run: |
          DEB_FILE=$(find release -name "*.deb" -type f | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb file found in release directory"
            exit 1
          fi
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "Found: $DEB_FILE"

          # Install required tools
          sudo apt-get update
          sudo apt-get install -y libarchive-tools
          
          # Create build directory
          mkdir -p arch-build
          cd arch-build
          
          # Copy PKGBUILD-bin as PKGBUILD
          cp ../PKGBUILD PKGBUILD
          cp ../remote-explorer-bin.install remote-explorer-bin.install
          cp ../.SRCINFO .SRCINFO
          
          # Extract version from deb filename
          DEB_NAME=$(basename "$DEB_FILE")
          VERSION=$(echo "$DEB_NAME" | sed -n 's/.*_\([0-9.]*\)_amd64.deb/\1/p')
          echo "Detected version: $VERSION"
          
          if [ -z "$VERSION" ]; then
            echo "Failed to extract version from: $DEB_NAME"
            exit 1
          fi
          
          # Copy the deb file to the build directory (handle spaces in filename)
          cp "../$DEB_FILE" "remote-explorer-${VERSION}.deb"
          
          # Calculate SHA256
          SHA256=$(sha256sum "remote-explorer-${VERSION}.deb" | awk '{print $1}')
          echo "SHA256: $SHA256"
          
          # Update PKGBUILD with version and checksum
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${SHA256}')/" PKGBUILD
          
          # Create output directory with proper permissions
          mkdir -p ../release-arch
          
          # Build in Docker with proper UID mapping
          docker run --rm \
            -v "$PWD:/pkg" \
            -v "$PWD/../release-arch:/output" \
            archlinux:latest bash -c "
            set -e
            pacman -Sy --noconfirm base-devel libarchive
            useradd -m builder
            chown -R builder:builder /pkg
            cd /pkg
            su builder -c 'makepkg --nodeps --skippgpcheck'
            # Copy as root to ensure permissions
            cp *.pkg.tar.zst /output/
            chmod 644 /output/*.pkg.tar.zst
          "

      - name: upload arch package
        uses: actions/upload-artifact@v4
        with:
          name: tauri-arch-linux
          path: release-arch/*.pkg.tar.zst

  build-fedora-package:
    name: Build Fedora RPM Package
    runs-on: ubuntu-latest
    needs: publish-tauri
    steps:
      - uses: actions/checkout@v4

      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: prepare release directory
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release

      - name: list artifacts
        run: |
          echo "Contents of release directory:"
          ls -laR release/
          
      - name: build fedora rpm
        run: |
          DEB_FILE=$(find release -name "*.deb" -type f | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb file found in release directory"
            exit 1
          fi
          echo "Found: $DEB_FILE"

          # Extract version from deb filename
          DEB_NAME=$(basename "$DEB_FILE")
          VERSION=$(echo "$DEB_NAME" | sed -n 's/.*_\([0-9.]*\)_amd64.deb/\1/p')
          echo "Detected version: $VERSION"
          
          if [ -z "$VERSION" ]; then
            echo "Failed to extract version from: $DEB_NAME"
            exit 1
          fi
          
          # Create output directory
          mkdir -p release-fedora
          
          # Build RPM in Fedora container
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            fedora:latest bash -c "
            set -e
            
            # Install required tools
            dnf install -y rpm-build rpmdevtools alien
            
            # Convert deb to rpm using alien
            alien -r -k '$DEB_FILE'
            
            # Find the generated RPM
            RPM_FILE=\$(find . -name '*.rpm' -type f | head -n 1)
            
            if [ -z \"\$RPM_FILE\" ]; then
              echo 'No RPM file was generated'
              exit 1
            fi
            
            # Move to output directory
            mv \"\$RPM_FILE\" release-fedora/remote-explorer-${VERSION}.x86_64.rpm
            chmod 644 release-fedora/*.rpm
          "

      - name: upload fedora package
        uses: actions/upload-artifact@v4
        with:
          name: tauri-fedora-linux
          path: release-fedora/*.rpm

  create-release:
    name: Create Stable Release
    runs-on: ubuntu-latest
    needs: [publish-tauri, build-arch-package, build-fedora-package]
    permissions:
      contents: write
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: prepare release directory
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release

      - name: create stable release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: "Release ${{ inputs.version }}"
          body: |
            ðŸš€ **Stable Release ${{ inputs.version }}**

            ## Installation

            ### Linux
            - **Arch Linux**: Download the `.pkg.tar.zst` file and install with `sudo pacman -U remote-explorer-bin-*.pkg.tar.zst`
            - **Fedora/RHEL**: Download the `.rpm` file and install with `sudo dnf install ./remote-explorer-*.rpm`
            - **Debian/Ubuntu**: Download the `.deb` file and install with `sudo apt install ./Remote.Explorer_*_amd64.deb`
            - **AppImage**: Download and run `chmod +x Remote.Explorer_*_amd64.AppImage && ./Remote.Explorer_*_amd64.AppImage`

            ### macOS
            Download the `.dmg` file for your architecture (Apple Silicon or Intel)

            ### Windows
            Download and run the `.msi` installer

            ### Android
            Download and install the `remote-explorer.apk`

            ## Full Changelog
            See commit history for detailed changes.
          files: release/*
          draft: false
          prerelease: false